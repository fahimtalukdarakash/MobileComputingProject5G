<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic 5G Topology</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }

        .navbar { background: #1e293b; border-bottom: 1px solid #334155; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
        .navbar h1 { font-size: 18px; font-weight: 600; color: #f8fafc; }
        .navbar h1 span { color: #38bdf8; }
        .badge-basic { background: rgba(251,146,60,0.15); color: #fb923c; border: 1px solid rgba(251,146,60,0.3); padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }

        .main { display: flex; height: calc(100vh - 49px); }

        /* Sidebar */
        .sidebar { width: 300px; min-width: 300px; background: #1e293b; border-right: 1px solid #334155; overflow-y: auto; }
        .sidebar-section { padding: 16px; border-bottom: 1px solid #334155; }
        .sidebar-section h3 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 12px; }

        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .status-card { background: #0f172a; border-radius: 8px; padding: 10px 12px; text-align: center; }
        .status-card .num { font-size: 22px; font-weight: 700; }
        .status-card .lbl { font-size: 10px; color: #94a3b8; text-transform: uppercase; margin-top: 2px; }

        .legend-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 13px; cursor: pointer; opacity: 1; transition: opacity 0.2s; }
        .legend-item:hover { opacity: 0.8; }
        .legend-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }

        .info-card { background: #0f172a; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; border-left: 3px solid; }
        .info-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .info-card p { font-size: 11px; color: #94a3b8; line-height: 1.4; }

        .node-detail { display: none; }
        .node-detail.visible { display: block; }
        .node-detail-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .node-detail-dot { width: 10px; height: 10px; border-radius: 50%; }
        .node-detail h4 { font-size: 15px; font-weight: 600; }
        .detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #1e293b; font-size: 12px; }
        .detail-row .key { color: #64748b; }
        .detail-row .val { color: #e2e8f0; font-family: 'JetBrains Mono', monospace; font-size: 11px; }
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
        .status-badge.running { background: #166534; color: #4ade80; }
        .status-badge.stopped { background: #7f1d1d; color: #f87171; }
        .status-badge.unknown { background: #3f3f46; color: #a1a1aa; }

        .filter-btn { background: transparent; border: 1px solid #334155; color: #94a3b8; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 2px; transition: all 0.2s; }
        .filter-btn.active { border-color: #38bdf8; color: #38bdf8; background: rgba(56,189,248,0.1); }
        .filter-btn:hover { border-color: #64748b; color: #e2e8f0; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 2px; }

        .graph-area { flex: 1; position: relative; }
        #topology-graph { width: 100%; height: 100%; }

        .toolbar { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; z-index: 10; }
        .toolbar button { background: #1e293b; border: 1px solid #334155; color: #e2e8f0; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .toolbar button:hover { background: #334155; border-color: #475569; }

        .loading { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #0f172a; z-index: 20; }
        .loading.hidden { display: none; }
        .loading-text { color: #94a3b8; font-size: 14px; }
        .spinner { width: 24px; height: 24px; border: 3px solid #334155; border-top-color: #38bdf8; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 12px; display: inline-block; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="navbar">
    <h1>üì° <span>5G</span> Basic Network Topology</h1>
    <span class="badge-basic">BASIC MODE ‚Ä¢ NO SLICING</span>
</div>

<div class="main">
    <div class="sidebar">
        <div class="sidebar-section">
            <h3>Network Status</h3>
            <div class="status-grid">
                <div class="status-card"><div class="num" style="color:#38bdf8" id="stat-total">-</div><div class="lbl">Total NFs</div></div>
                <div class="status-card"><div class="num" style="color:#4ade80" id="stat-running">-</div><div class="lbl">Running</div></div>
                <div class="status-card"><div class="num" style="color:#f87171" id="stat-stopped">-</div><div class="lbl">Stopped</div></div>
                <div class="status-card"><div class="num" style="color:#fb923c" id="stat-ues">5</div><div class="lbl">UEs</div></div>
            </div>
        </div>

        <div class="sidebar-section">
            <h3>Filter by Layer</h3>
            <div class="filter-group" id="filter-group"></div>
        </div>

        <div class="sidebar-section">
            <h3>Architecture</h3>
            <div class="info-card" style="border-color:#2563EB">
                <h4 style="color:#60a5fa">5G Core</h4>
                <p>Single AMF/SMF/UPF ‚Äî no network slicing. All UEs share one PDU session path. Network: <code style="font-size:10px;color:#38bdf8">10.33.33.0/24</code></p>
            </div>
            <div class="info-card" style="border-color:#16A34A">
                <h4 style="color:#4ade80">RAN</h4>
                <p>Single gNodeB ‚Äî all 5 UEs (3 IoT + 2 Vehicle) connect through this base station.</p>
            </div>
            <div class="info-card" style="border-color:#0891B2">
                <h4 style="color:#22d3ee">IoT UEs (3)</h4>
                <p>Temp/Humidity, Air Quality, Pressure sensors ‚Üí MQTT topics <code style="font-size:10px;color:#22d3ee">iot/ue-iot-*</code></p>
            </div>
            <div class="info-card" style="border-color:#EA580C">
                <h4 style="color:#fb923c">Vehicle UEs (2)</h4>
                <p>GPS + Speed + Alerts ‚Üí HTTP to Edge ‚Üí MQTT <code style="font-size:10px;color:#fb923c">veh/telemetry</code></p>
            </div>
            <div class="info-card" style="border-color:#DB2777">
                <h4 style="color:#f472b6">Applications</h4>
                <p>MQTT (:1883) + Edge Flask (:5000) + Node-RED Dashboard (:1880)</p>
            </div>
        </div>

        <div class="sidebar-section node-detail" id="node-detail">
            <h3>Selected Node</h3>
            <div class="node-detail-header">
                <div class="node-detail-dot" id="detail-dot"></div>
                <h4 id="detail-name"></h4>
            </div>
            <div id="detail-content"></div>
        </div>
    </div>

    <div class="graph-area">
        <div class="loading" id="loading">
            <div class="loading-text"><span class="spinner"></span>Loading basic topology...</div>
        </div>
        <div class="toolbar">
            <button onclick="fitGraph()">‚äû Fit</button>
            <button onclick="refreshTopology()">‚ü≥ Refresh</button>
            <button onclick="togglePhysics()">‚ö° Physics</button>
        </div>
        <div id="topology-graph"></div>
    </div>
</div>

<script>
(function() {
let network = null;
let allNodes = null;
let allEdges = null;
let topologyData = null;
let physicsEnabled = false;
let activeFilters = new Set();
const API_BASE = window.location.origin;

// =============================================================================
// Layout positions (logical 5G architecture layout)
// =============================================================================
const POSITIONS = {
    // Simulators (far left)
    'sim-iot-01': { x: -750, y: -200 },
    'sim-iot-02': { x: -750, y: 0 },
    'sim-iot-03': { x: -750, y: 200 },
    'sim-veh-01': { x: -750, y: 420 },
    'sim-veh-02': { x: -750, y: 570 },

    // UEs
    'ue-iot-01': { x: -500, y: -200 },
    'ue-iot-02': { x: -500, y: 0 },
    'ue-iot-03': { x: -500, y: 200 },
    'ue-veh-01': { x: -500, y: 420 },
    'ue-veh-02': { x: -500, y: 570 },

    // gNodeB (center-left)
    gnb: { x: -180, y: 150 },

    // Core CP (center)
    amf:  { x: 80,  y: 80 },
    smf:  { x: 280, y: 80 },
    upf:  { x: 280, y: 280 },

    // SBA NFs (top)
    nrf:  { x: 80,   y: -200 },
    ausf: { x: -80,  y: -80 },
    udm:  { x: 80,   y: -80 },
    udr:  { x: 230,  y: -80 },
    nssf: { x: -230, y: -80 },
    bsf:  { x: -230, y: -200 },
    pcf:  { x: 380,  y: -80 },

    // Infrastructure (top-right)
    db:    { x: 380,  y: -230 },
    webui: { x: 530,  y: -230 },

    // Application Layer (right)
    mqtt:    { x: 530, y: 120 },
    edge:    { x: 530, y: 320 },
    nodered: { x: 530, y: 520 },
};

const CAT_COLORS = {
    core_cp:   '#2563EB',
    core_up:   '#7C3AED',
    ran:       '#16A34A',
    iot:       '#0891B2',
    vehicle:   '#EA580C',
    simulator: '#6B7280',
    apps:      '#DB2777',
    infra:     '#92400E',
};

const EDGE_COLORS = {
    'SBI':        '#475569',
    'NGAP (N2)':  '#3b82f6',
    'PFCP (N4)':  '#8b5cf6',
    'GTP-U (N3)': '#22c55e',
    'NR-Uu':      '#06b6d4',
    'container':  '#4b5563',
    'IP':         '#a855f7',
    'MQTT':       '#ec4899',
    'MongoDB':    '#92400E',
};

// =============================================================================
// Build Graph from API data
// =============================================================================
function buildGraph(data) {
    topologyData = data;

    // Build filter buttons
    const filterGroup = document.getElementById('filter-group');
    filterGroup.innerHTML = '<button class="filter-btn active" data-cat="all" onclick="toggleFilter(this)">All</button>';
    Object.entries(data.categories).forEach(([cat, style]) => {
        activeFilters.add(cat);
        filterGroup.innerHTML += `<button class="filter-btn active" data-cat="${cat}" onclick="toggleFilter(this)" style="border-color:${style.color}50;color:${style.color}">${style.name}</button>`;
    });
    activeFilters.add('all');

    const visNodes = data.nodes.map(n => {
        const cat = data.categories[n.category] || {};
        const color = cat.color || '#475569';
        const pos = POSITIONS[n.id] || { x: 0, y: 0 };
        const ip = (n.networks && n.networks[0]) ? n.networks[0].ip : '';

        let labelText = n.label;
        if (ip) labelText += `\n${ip}`;

        return {
            id: n.id,
            label: labelText,
            x: pos.x, y: pos.y,
            fixed: true,
            shape: cat.shape === 'diamond' ? 'diamond' : (cat.shape === 'database' ? 'database' : 'box'),
            size: cat.shape === 'diamond' ? 25 : undefined,
            color: {
                background: n.running ? `${color}25` : '#1e293b',
                border: n.running ? color : '#475569',
                highlight: { background: `${color}40`, border: color },
                hover: { background: `${color}30`, border: color },
            },
            font: {
                color: n.running ? '#e2e8f0' : '#64748b',
                face: "'Segoe UI', system-ui, sans-serif",
                size: 12,
                multi: true,
            },
            borderWidth: n.running ? 2 : 1,
            borderDashes: n.category === 'simulator' ? [4, 3] : false,
            margin: 10,
            shadow: n.running ? { enabled: true, color: `${color}30`, size: 10, x: 0, y: 3 } : false,
            title: `${n.fullname}\n${n.role}\nStatus: ${n.status}${ip ? '\nIP: ' + ip : ''}`,
            category: n.category,
            _data: n,
        };
    });

    const visEdges = data.edges.map(e => ({
        from: e.from,
        to: e.to,
        label: e.protocol,
        title: `${e.protocol}: ${e.description}`,
        color: { color: EDGE_COLORS[e.protocol] || '#475569', opacity: 0.5, highlight: '#f8fafc', hover: '#94a3b8' },
        font: { color: '#64748b', size: 9, strokeWidth: 0, align: 'top' },
        width: e.protocol.includes('GTP') || e.protocol.includes('NR-Uu') ? 2.5 : 1,
        dashes: e.protocol === 'NR-Uu' ? [8, 4] : (e.protocol === 'container' ? [3, 3] : false),
        smooth: { type: 'curvedCW', roundness: 0.15 },
        arrows: { to: { enabled: true, scaleFactor: 0.5 } },
    }));

    allNodes = new vis.DataSet(visNodes);
    allEdges = new vis.DataSet(visEdges);

    const container = document.getElementById('topology-graph');
    network = new vis.Network(container, { nodes: allNodes, edges: allEdges }, {
        physics: { enabled: physicsEnabled, stabilization: false },
        interaction: { hover: true, tooltipDelay: 200, zoomView: true, dragView: true },
        edges: { selectionWidth: 2 },
    });

    // Stats
    const running = data.nodes.filter(n => n.running).length;
    const stopped = data.nodes.filter(n => !n.running && n.status !== 'not found').length;
    document.getElementById('stat-total').textContent = data.nodes.length;
    document.getElementById('stat-running').textContent = running;
    document.getElementById('stat-stopped').textContent = stopped;

    network.on('click', function(params) {
        if (params.nodes.length > 0) showNodeDetail(params.nodes[0]);
        else hideNodeDetail();
    });

    network.once('afterDrawing', () => {
        network.fit({ animation: { duration: 500, easingFunction: 'easeInOutQuad' } });
    });

    document.getElementById('loading').classList.add('hidden');
}

// =============================================================================
// Node detail panel
// =============================================================================
function showNodeDetail(nodeId) {
    const nodeVis = allNodes.get(nodeId);
    if (!nodeVis) return;
    const n = nodeVis._data;
    const cat = topologyData.categories[n.category] || {};

    const panel = document.getElementById('node-detail');
    panel.classList.add('visible');

    document.getElementById('detail-dot').style.background = cat.color || '#666';
    document.getElementById('detail-name').textContent = n.fullname;

    const statusClass = n.running ? 'running' : (n.status === 'not found' ? 'unknown' : 'stopped');
    let html = `
        <div class="detail-row"><span class="key">Status</span><span class="status-badge ${statusClass}">${n.status}</span></div>
        <div class="detail-row"><span class="key">Category</span><span class="val">${cat.name || n.category}</span></div>
        <div class="detail-row"><span class="key">Role</span><span class="val">${n.role}</span></div>
    `;
    if (n.image) html += `<div class="detail-row"><span class="key">Image</span><span class="val">${n.image.split('/').pop()}</span></div>`;

    if (n.networks && n.networks.length > 0) {
        n.networks.forEach(net => {
            html += `<div class="detail-row"><span class="key">IP (${net.network})</span><span class="val">${net.ip || 'N/A'}</span></div>`;
            if (net.mac) html += `<div class="detail-row"><span class="key">MAC</span><span class="val">${net.mac}</span></div>`;
        });
    }

    const connected = topologyData.edges.filter(e => e.from === nodeId || e.to === nodeId);
    if (connected.length > 0) {
        html += `<div style="margin-top:12px;padding-top:8px;border-top:1px solid #334155"><span class="key" style="font-size:11px">CONNECTIONS (${connected.length})</span></div>`;
        connected.forEach(e => {
            const peer = e.from === nodeId ? e.to : e.from;
            html += `<div class="detail-row"><span class="key">${peer.toUpperCase()}</span><span class="val">${e.protocol}</span></div>`;
        });
    }

    document.getElementById('detail-content').innerHTML = html;
}

function hideNodeDetail() {
    document.getElementById('node-detail').classList.remove('visible');
}

// =============================================================================
// Filters
// =============================================================================
function toggleFilter(btn) {
    const cat = btn.dataset.cat;
    if (cat === 'all') {
        const allActive = document.querySelectorAll('.filter-btn.active').length === document.querySelectorAll('.filter-btn').length;
        document.querySelectorAll('.filter-btn').forEach(b => {
            if (allActive) { b.classList.remove('active'); activeFilters.clear(); }
            else { b.classList.add('active'); activeFilters.add(b.dataset.cat); }
        });
    } else {
        btn.classList.toggle('active');
        if (activeFilters.has(cat)) activeFilters.delete(cat); else activeFilters.add(cat);
        const allBtn = document.querySelector('.filter-btn[data-cat="all"]');
        const nonAllBtns = document.querySelectorAll('.filter-btn:not([data-cat="all"])');
        const allActive = [...nonAllBtns].every(b => b.classList.contains('active'));
        allActive ? allBtn.classList.add('active') : allBtn.classList.remove('active');
    }
    applyFilters();
}

function applyFilters() {
    if (!allNodes || !topologyData) return;
    allNodes.forEach(node => {
        const show = activeFilters.has(node.category);
        allNodes.update({ id: node.id, hidden: !show });
    });
    allEdges.forEach(edge => {
        const fromNode = allNodes.get(edge.from);
        const toNode = allNodes.get(edge.to);
        const show = fromNode && !fromNode.hidden && toNode && !toNode.hidden;
        allEdges.update({ id: edge.id, hidden: !show });
    });
}

// =============================================================================
// Toolbar
// =============================================================================
function fitGraph() { if (network) network.fit({ animation: { duration: 500, easingFunction: 'easeInOutQuad' } }); }

function togglePhysics() {
    physicsEnabled = !physicsEnabled;
    if (network) {
        network.setOptions({ physics: { enabled: physicsEnabled } });
        allNodes.forEach(n => { allNodes.update({ id: n.id, fixed: !physicsEnabled }); });
    }
}

function refreshTopology() {
    document.getElementById('loading').classList.remove('hidden');
    hideNodeDetail();
    fetchTopology();
}

// =============================================================================
// Fetch from API
// =============================================================================
function fetchTopology() {
    fetch(`${API_BASE}/api/topology/basic`)
        .then(r => r.json())
        .then(data => buildGraph(data))
        .catch(err => {
            console.error('Topology fetch failed:', err);
            document.getElementById('loading').innerHTML =
                '<div class="loading-text" style="color:#f87171">‚ùå Failed to connect to API.<br>Make sure the framework is running:<br><code style="color:#94a3b8">python -m uvicorn framework.app:app --port 8000</code></div>';
        });
}

// Expose to window for onclick handlers
window.toggleFilter = toggleFilter;
window.fitGraph = fitGraph;
window.togglePhysics = togglePhysics;
window.refreshTopology = refreshTopology;

fetchTopology();
})();
</script>
</body>
</html>